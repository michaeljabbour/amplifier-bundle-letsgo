<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LetsGo Canvas</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
  :root {
    --sidebar-width: 260px;
    --bg: #f8f9fa;
    --bg-sidebar: #ffffff;
    --bg-main: #ffffff;
    --border: #dee2e6;
    --text: #212529;
    --text-secondary: #6c757d;
    --accent: #0d6efd;
    --accent-bg: #e7f1ff;
    --badge-chart: #198754;
    --badge-html: #dc3545;
    --badge-svg: #6f42c1;
    --badge-markdown: #0dcaf0;
    --badge-code: #fd7e14;
    --badge-table: #20c997;
    --flash: rgba(13, 110, 253, 0.15);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* -- Sidebar ------------------------------------------------------------ */
  #sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #sidebar-header {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  #sidebar-header h1 {
    font-size: 16px;
    font-weight: 600;
  }
  #connection-status {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #dc3545;
    transition: background 0.3s;
  }
  #connection-status.connected { background: #198754; }
  #item-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }
  .item-entry {
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.15s;
  }
  .item-entry:hover { background: var(--bg); }
  .item-entry.selected { background: var(--accent-bg); }
  .item-entry.flash {
    animation: flash-update 0.6s ease-out;
  }
  @keyframes flash-update {
    0% { background: var(--flash); }
    100% { background: transparent; }
  }
  .item-badge {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    padding: 2px 6px;
    border-radius: 3px;
    color: #fff;
    white-space: nowrap;
  }
  .badge-chart { background: var(--badge-chart); }
  .badge-html { background: var(--badge-html); }
  .badge-svg { background: var(--badge-svg); }
  .badge-markdown { background: var(--badge-markdown); color: #000; }
  .badge-code { background: var(--badge-code); }
  .badge-table { background: var(--badge-table); }
  .badge-text { background: var(--text-secondary); }
  .item-title {
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }
  #empty-sidebar {
    padding: 24px 16px;
    text-align: center;
    color: var(--text-secondary);
    font-size: 13px;
  }

  /* -- Main panel --------------------------------------------------------- */
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  #main-header {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-main);
    display: flex;
    align-items: center;
    gap: 10px;
    min-height: 48px;
  }
  #main-header h2 {
    font-size: 14px;
    font-weight: 600;
    flex: 1;
  }
  #main-header .badge-type {
    font-size: 11px;
    color: var(--text-secondary);
  }
  #content-area {
    flex: 1;
    overflow: auto;
    padding: 20px;
    background: var(--bg-main);
  }
  #empty-content {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
    font-size: 15px;
  }

  /* -- Content renderers -------------------------------------------------- */
  #content-area iframe {
    width: 100%;
    min-height: 400px;
    border: 1px solid var(--border);
    border-radius: 4px;
  }
  #content-area pre {
    background: #f6f8fa;
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 13px;
    line-height: 1.5;
  }
  #content-area table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  #content-area th, #content-area td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }
  #content-area th {
    background: var(--bg);
    font-weight: 600;
    position: sticky;
    top: 0;
  }
  .markdown-body { line-height: 1.6; font-size: 14px; }
  .markdown-body h1 { font-size: 1.8em; margin: 0.5em 0 0.3em; }
  .markdown-body h2 { font-size: 1.4em; margin: 0.5em 0 0.3em; }
  .markdown-body h3 { font-size: 1.2em; margin: 0.5em 0 0.3em; }
  .markdown-body p { margin: 0.5em 0; }
  .markdown-body code {
    background: #f0f0f0; padding: 2px 5px; border-radius: 3px; font-size: 0.9em;
  }
  .markdown-body pre code { background: none; padding: 0; }
  .markdown-body ul, .markdown-body ol { margin: 0.5em 0; padding-left: 2em; }
  .markdown-body blockquote {
    border-left: 3px solid var(--border);
    padding-left: 12px;
    color: var(--text-secondary);
    margin: 0.5em 0;
  }
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div id="sidebar-header">
    <h1>Canvas</h1>
    <div id="connection-status" title="Disconnected"></div>
  </div>
  <div id="item-list">
    <div id="empty-sidebar">Waiting for content...</div>
  </div>
</div>

<!-- Main panel -->
<div id="main">
  <div id="main-header">
    <h2 id="selected-title">No item selected</h2>
    <span id="selected-type" class="badge-type"></span>
  </div>
  <div id="content-area">
    <div id="empty-content">Select an item from the sidebar or push content via canvas_push</div>
  </div>
</div>

<!-- CDN dependencies -->
<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
(function() {
  'use strict';

  // -- State ----------------------------------------------------------------
  const items = new Map(); // id -> {content_type, content, title}
  const order = [];        // item ids, newest first
  let selectedId = null;
  let ws = null;
  let reconnectDelay = 1000;
  const MAX_RECONNECT = 30000;

  // -- DOM refs -------------------------------------------------------------
  const itemList = document.getElementById('item-list');
  const emptySidebar = document.getElementById('empty-sidebar');
  const contentArea = document.getElementById('content-area');
  const emptyContent = document.getElementById('empty-content');
  const selectedTitle = document.getElementById('selected-title');
  const selectedType = document.getElementById('selected-type');
  const statusDot = document.getElementById('connection-status');

  // -- WebSocket connection -------------------------------------------------
  function connect() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/canvas/ws');

    ws.onopen = function() {
      statusDot.classList.add('connected');
      statusDot.title = 'Connected';
      reconnectDelay = 1000;
      // Restore state on reconnect
      fetchState();
    };

    ws.onclose = function() {
      statusDot.classList.remove('connected');
      statusDot.title = 'Disconnected — reconnecting...';
      scheduleReconnect();
    };

    ws.onerror = function() {
      ws.close();
    };

    ws.onmessage = function(event) {
      try {
        const msg = JSON.parse(event.data);
        if (msg.type === 'update') {
          handleUpdate(msg);
        }
      } catch (e) {
        console.error('Failed to parse WebSocket message:', e);
      }
    };
  }

  function scheduleReconnect() {
    setTimeout(function() {
      reconnectDelay = Math.min(reconnectDelay * 1.5, MAX_RECONNECT);
      connect();
    }, reconnectDelay);
  }

  // -- State recovery -------------------------------------------------------
  function fetchState() {
    fetch('/canvas/state')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.items && data.items.length > 0) {
          // Clear and rebuild
          items.clear();
          order.length = 0;
          data.items.forEach(function(item) {
            items.set(item.id, {
              content_type: item.content_type,
              content: item.content,
              title: item.title
            });
            order.push(item.id);
          });
          renderSidebar();
          if (!selectedId || !items.has(selectedId)) {
            selectItem(order[0]);
          } else {
            renderContent(selectedId);
          }
        }
      })
      .catch(function(e) {
        console.error('Failed to fetch state:', e);
      });
  }

  // -- Update handler -------------------------------------------------------
  function handleUpdate(msg) {
    const id = msg.id;
    const isUpdate = items.has(id);

    items.set(id, {
      content_type: msg.content_type,
      content: msg.content,
      title: msg.title
    });

    // Update order — newest first
    const idx = order.indexOf(id);
    if (idx > -1) order.splice(idx, 1);
    order.unshift(id);

    renderSidebar();

    // Flash updated item
    if (isUpdate) {
      const el = document.querySelector('[data-id="' + id + '"]');
      if (el) {
        el.classList.add('flash');
        setTimeout(function() { el.classList.remove('flash'); }, 600);
      }
    }

    // Auto-select new items (not updates)
    if (!isUpdate) {
      selectItem(id);
    } else if (selectedId === id) {
      renderContent(id);
    }
  }

  // -- Sidebar rendering ----------------------------------------------------
  function renderSidebar() {
    if (order.length === 0) {
      itemList.innerHTML = '';
      itemList.appendChild(emptySidebar);
      return;
    }

    itemList.innerHTML = '';
    order.forEach(function(id) {
      const item = items.get(id);
      const entry = document.createElement('div');
      entry.className = 'item-entry' + (id === selectedId ? ' selected' : '');
      entry.setAttribute('data-id', id);
      entry.onclick = function() { selectItem(id); };

      const badge = document.createElement('span');
      badge.className = 'item-badge badge-' + (item.content_type || 'text');
      badge.textContent = item.content_type || 'text';

      const title = document.createElement('span');
      title.className = 'item-title';
      title.textContent = item.title || id;

      entry.appendChild(badge);
      entry.appendChild(title);
      itemList.appendChild(entry);
    });
  }

  // -- Content selection and rendering --------------------------------------
  function selectItem(id) {
    selectedId = id;
    renderSidebar(); // Update selection highlight
    renderContent(id);
  }

  function renderContent(id) {
    const item = items.get(id);
    if (!item) {
      contentArea.innerHTML = '';
      contentArea.appendChild(emptyContent);
      selectedTitle.textContent = 'No item selected';
      selectedType.textContent = '';
      return;
    }

    selectedTitle.textContent = item.title || id;
    selectedType.textContent = item.content_type;
    contentArea.innerHTML = '';

    switch (item.content_type) {
      case 'chart':
        renderChart(item.content);
        break;
      case 'html':
        renderHTML(item.content);
        break;
      case 'svg':
        renderSVG(item.content);
        break;
      case 'markdown':
        renderMarkdown(item.content);
        break;
      case 'code':
        renderCode(item.content);
        break;
      case 'table':
        renderTable(item.content);
        break;
      default:
        renderText(item.content);
    }
  }

  // -- Renderers ------------------------------------------------------------
  function renderChart(content) {
    var container = document.createElement('div');
    contentArea.appendChild(container);
    try {
      var spec = typeof content === 'string' ? JSON.parse(content) : content;
      vegaEmbed(container, spec, {actions: true, renderer: 'svg'})
        .catch(function(err) {
          container.textContent = 'Chart render error: ' + err.message;
        });
    } catch (e) {
      container.textContent = 'Invalid Vega-Lite spec: ' + e.message;
    }
  }

  function renderHTML(content) {
    var iframe = document.createElement('iframe');
    iframe.sandbox = 'allow-scripts';
    iframe.style.width = '100%';
    iframe.style.minHeight = '400px';
    iframe.style.border = '1px solid var(--border)';
    iframe.style.borderRadius = '4px';
    contentArea.appendChild(iframe);
    iframe.srcdoc = content;
    // Auto-resize iframe to content
    iframe.onload = function() {
      try {
        var h = iframe.contentDocument.body.scrollHeight;
        iframe.style.height = Math.max(h + 20, 200) + 'px';
      } catch(e) { /* cross-origin */ }
    };
  }

  function renderSVG(content) {
    var container = document.createElement('div');
    container.innerHTML = content;
    contentArea.appendChild(container);
  }

  function renderMarkdown(content) {
    var container = document.createElement('div');
    container.className = 'markdown-body';
    container.innerHTML = marked.parse(content);
    // Highlight code blocks
    container.querySelectorAll('pre code').forEach(function(block) {
      hljs.highlightElement(block);
    });
    contentArea.appendChild(container);
  }

  function renderCode(content) {
    var pre = document.createElement('pre');
    var code = document.createElement('code');
    code.textContent = content;
    pre.appendChild(code);
    contentArea.appendChild(pre);
    hljs.highlightElement(code);
  }

  function renderTable(content) {
    try {
      var data = typeof content === 'string' ? JSON.parse(content) : content;
      if (!Array.isArray(data) || data.length === 0) {
        contentArea.textContent = 'Empty or invalid table data';
        return;
      }

      var table = document.createElement('table');
      var thead = document.createElement('thead');
      var headerRow = document.createElement('tr');
      var keys = Object.keys(data[0]);

      keys.forEach(function(key) {
        var th = document.createElement('th');
        th.textContent = key;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      var tbody = document.createElement('tbody');
      data.forEach(function(row) {
        var tr = document.createElement('tr');
        keys.forEach(function(key) {
          var td = document.createElement('td');
          td.textContent = row[key] != null ? String(row[key]) : '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      contentArea.appendChild(table);
    } catch (e) {
      contentArea.textContent = 'Invalid table JSON: ' + e.message;
    }
  }

  function renderText(content) {
    var pre = document.createElement('pre');
    pre.style.whiteSpace = 'pre-wrap';
    pre.textContent = content;
    contentArea.appendChild(pre);
  }

  // -- Init -----------------------------------------------------------------
  connect();

})();
</script>
</body>
</html>
